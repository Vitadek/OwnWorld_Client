<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OwnWorld Commander</title>
    <style>
        :root { --bg:#050510; --panel:#151520; --accent:#00d2ff; --warn:#ffae00; --danger:#ff3333; --success:#00ff9d; --text:#ddd; }
        body { background:var(--bg); color:var(--text); font-family:monospace; margin:0; padding:20px; }
        .grid { display:grid; grid-template-columns: 1fr 350px; gap:20px; }
        .panel { background:var(--panel); border:1px solid #333; padding:15px; margin-bottom:15px; }
        
        button { background:transparent; border:1px solid var(--accent); color:var(--accent); padding:5px 10px; cursor:pointer; margin:2px; font-family:inherit; transition:0.2s; }
        button:hover { background:var(--accent); color:#000; }
        button:disabled { border-color:#555; color:#555; cursor:wait; }
        
        .tab-bar { margin-bottom:15px; border-bottom:1px solid #444; }
        .tab { padding:10px; border:none; background:none; color:#666; cursor:pointer; font-size:1.1em; }
        .tab.active { color:var(--accent); border-bottom:2px solid var(--accent); }
        
        input, select { background:#000; color:#fff; border:1px solid #555; padding:5px; width:100%; box-sizing:border-box; }
        
        .res-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin:10px 0; text-align:center; font-size:0.85em; }
        .res-box { background:#222; padding:5px; border-bottom:2px solid #555; position:relative; }
        .val-rate { font-size:0.8em; display:block; margin-top:2px; }
        
        /* Modal */
        #modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; }
        #build-modal { background:var(--panel); border:1px solid var(--accent); padding:20px; width:700px; max-width:95%; max-height:90vh; overflow-y:auto; display:flex; flex-direction:column; }
        
        .catalog-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(130px, 1fr)); gap:10px; margin-top:10px; }
        .catalog-item { border:1px solid #444; padding:10px; cursor:pointer; text-align:center; transition:0.2s; background:#111; }
        .catalog-item:hover { border-color:var(--accent); background:#1a1a2e; }
        .catalog-item.selected { border-color:var(--success); background:#1a2e1a; box-shadow:0 0 10px rgba(0,255,157,0.2); }
        
        .audit-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:15px; background:#000; padding:15px; border:1px solid #333; }
        .audit-row { display:flex; justify-content:space-between; font-size:0.9em; border-bottom:1px solid #222; padding:3px 0; }
        .stat-good { color:var(--success); }
        .stat-bad { color:var(--danger); }
        
        .build-card { background:#1a1a24; border:1px solid #333; padding:5px; font-size:0.8em; text-align:center; }
    </style>
</head>
<body>

<!-- BUILD MODAL -->
<div id="modal-overlay">
    <div id="build-modal">
        <h3 id="modal-title" style="margin-top:0; border-bottom:1px solid var(--accent); padding-bottom:10px;">CONSTRUCTION TERMINAL</h3>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <div>
                <label>Order Amount:</label>
                <input type="number" id="build-amount" value="1" min="1" style="width:70px; text-align:center; font-weight:bold; color:var(--accent);" onchange="updateCostPreview()">
            </div>
            <div id="selection-name" style="color:var(--text); font-weight:bold;">SELECT BLUEPRINT</div>
        </div>

        <div id="catalog-container" class="catalog-grid"></div>
        
        <!-- Live Audit -->
        <div class="audit-container">
            <div>
                <strong style="color:var(--warn)">RESOURCE COST</strong>
                <div id="audit-cost"></div>
            </div>
            <div>
                <strong style="color:var(--success)">PROJECTED IMPACT (PER TICK)</strong>
                <div id="audit-impact"></div>
            </div>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button id="btn-confirm-build" onclick="confirmBuild()" style="flex-grow:1; font-size:1.1em; padding:15px; font-weight:bold;">AUTHORIZE CONSTRUCTION</button>
            <button class="btn-dang" onclick="closeModal()" style="border-color:var(--danger); color:var(--danger)">CANCEL</button>
        </div>
    </div>
</div>

<!-- AUTH -->
<div id="auth" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); text-align:center; padding-top:100px; z-index:900;">
    <h1 style="color:var(--accent)">OWNWORLD UPLINK</h1>
    <div style="background:var(--panel); display:inline-block; padding:30px; border:1px solid var(--accent);">
        <input id="srv-url" value="http://localhost:8080" placeholder="Server URL"><br><br>
        <input id="user" placeholder="Username"><br><br>
        <input id="pass" type="password" placeholder="Password"><br><br>
        <button onclick="auth('login')" style="width:100%; padding:10px;">LOGIN</button>
        <button onclick="auth('register')" style="width:100%; padding:10px; margin-top:5px;">REGISTER</button>
        <div id="auth-msg" style="color:var(--danger); margin-top:10px;"></div>
    </div>
</div>

<div class="tab-bar">
    <button id="tab-colonies" class="tab active" onclick="setTab('colonies')">COLONIES</button>
    <button id="tab-fleet" class="tab" onclick="setTab('fleet')">FLEET COMMAND</button>
    <button id="tab-intel" class="tab" onclick="setTab('intel')">STAR INTEL</button>
</div>

<div class="grid">
    <div id="main-view"></div>
    <div class="sidebar">
        <div class="panel">
            <h3>LOGS</h3>
            <div id="logs" style="height:200px; overflow-y:auto; font-size:0.8em; color:#888; border:1px solid #333; padding:5px;"></div>
        </div>
        <div class="panel">
            <h3>SECTOR INFO</h3>
            <div>ID: <span id="srv-uuid" style="color:var(--accent)">...</span></div>
            <div>COORDS: <span id="srv-loc" style="color:var(--warn)">...</span></div>
        </div>
    </div>
</div>

<script>
    let API = "http://localhost:8080";
    let UID = null;
    let STATE = null;
    let TAB = 'colonies';
    let KNOWN_NETWORKS = JSON.parse(localStorage.getItem('ownworld_nets') || "[]");
    let CURRENT_COL = null; 
    let SELECTED_STRUCT = null;
    let BUILD_MODE = 'structure';

    // --- MATH ---
    function calcResRates(c) {
        let b = c.buildings || {};
        let eff = 1.0 + ((b.rd_lab||0) * ((c.intelligence||0) / 200.0));
        let consumption = Math.floor((c.population||0) / 3);
        return {
            food: ((b.farm||0) * 100 * eff) - consumption,
            water: ((b.well||0) * 100 * eff) - consumption,
            iron: (b.iron_mine||0) * 10 * eff,
            diamond: (b.diamond_mine||0) * 5 * eff,
            platinum: (b.platinum_mine||0) * 2 * eff,
            starfuel: (b.starfuel_refinery||0) * 1 * eff
        };
    }

    function calcStatRates(c) {
        let b = c.buildings || {};
        let pop = c.population || 0;
        let health = c.health || 0;
        let crime = c.crime || 0;
        let happy = c.happiness || 0;
        let intel = c.intelligence || 0;

        let targetCrime = (pop / 1000.0) - ((b.police_station||0) * 2.0);
        if (targetCrime < 0) targetCrime = 0;
        let crimeDrift = (targetCrime - crime) * 0.1;

        let crowding = pop / (5000.0 * Math.log10(pop + 10));
        let healing = (b.hospital||0) * 1.5 * (1.0 + intel/100.0);
        let targetHealth = health - crowding + healing;
        if (targetHealth > 100) targetHealth = 100; if (targetHealth < 0) targetHealth = 0;
        let healthDrift = (targetHealth - health) * 0.1;

        let targetHappy = health - (crime * 5.0);
        if ((c.food||0) < pop) targetHappy -= 20; if ((c.water||0) < pop) targetHappy -= 20;
        if (targetHappy > 100) targetHappy = 100; if (targetHappy < 0) targetHappy = 0;
        let happyDrift = (targetHappy - happy) * 0.1;

        let logDamp = Math.log(pop + 10.0);
        let popRate = 0;
        
        // REVISED LOGIC: Match Server's "Growth OR Death" priority
        if (happy > 60 && (c.food||0) > 0) {
            // Server checks Happy > 60 && Food > 0. Water is irrelevant for growth if happy.
            let growth = pop * 0.01 * (happy / 100.0);
            popRate = growth / logDamp;
        } else if ((c.food||0) <= 0 || (c.water||0) <= 0) {
            // Death triggers only if growth failed AND resources empty
            let death = pop * 0.02;
            popRate = -(death / logDamp);
        }
        
        return { crime: crimeDrift, health: healthDrift, happy: happyDrift, pop: popRate };
    }

    // --- SYSTEM ---
    function log(msg) {
        let l = document.getElementById('logs');
        let time = new Date().toLocaleTimeString().split(' ')[0];
        l.innerHTML = `<div><span style="color:#555">[${time}]</span> ${msg}</div>` + l.innerHTML;
    }

    async function auth(type) {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        API = document.getElementById('srv-url').value.replace(/\/$/, "");
        try {
            const res = await fetch(`${API}/${type}`, {
                method:'POST', headers: {'Content-Type': 'application/json'},
                body:JSON.stringify({Username:u, Password:p})
            });
            if(res.ok) {
                const d = await res.json();
                UID = d.user_id;
                document.getElementById('auth').style.display='none';
                startLoop();
            } else { document.getElementById('auth-msg').innerText = await res.text(); }
        } catch(e) { document.getElementById('auth-msg').innerText = "Connection Error"; }
    }

    function startLoop() { refresh(); setInterval(refresh, 2000); }

    async function refresh() {
        if(!UID) return;
        try {
            const res = await fetch(`${API}/state`, {headers:{'X-User-ID':UID}});
            if(res.ok) { STATE = await res.json(); render(); }
        } catch(e){}
    }

    // --- UI HELPERS ---
    function fmtRate(val, isBadHigh=false) {
        let n = parseFloat(val) || 0;
        if (Math.abs(n) < 0.01 && n !== 0) return "~0/t";
        if (Math.abs(n) < 0.1) return n > 0 ? "+0.0/t" : "-0.0/t";
        let s = n > 0 ? "+" : "";
        let color = "var(--text)";
        if (n > 0) color = isBadHigh ? "var(--danger)" : "var(--success)";
        if (n < 0) color = isBadHigh ? "var(--success)" : "var(--danger)";
        return `<span style="color:${color}">${s}${n.toFixed(1)}/t</span>`;
    }

    function resBox(label, val, rate) {
        return `<div class="res-box">${label}<br>
            <span style="color:#fff; font-weight:bold; font-size:1.1em;">${Math.floor(val||0)}</span>
            <span class="val-rate">${fmtRate(rate)}</span>
        </div>`;
    }

    // --- BUILD LOGIC ---
    function openBuildModal(colId, mode = 'structure') {
        CURRENT_COL = STATE.MyColonies.find(c => c.id === colId);
        SELECTED_STRUCT = null;
        BUILD_MODE = mode;
        const container = document.getElementById('catalog-container');
        container.innerHTML = '';
        document.getElementById('modal-title').innerText = mode === 'ship' ? "SHIPYARD CATALOG" : "CONSTRUCTION TERMINAL";
        const source = mode === 'ship' ? STATE.ShipCosts : STATE.Costs;

        if (source) {
            for (const [key, cost] of Object.entries(source)) {
                let div = document.createElement('div');
                div.className = 'catalog-item';
                div.onclick = () => selectStruct(div, key);
                let costStr = Object.entries(cost).map(([k,v]) => {
                    let c = '#888';
                    if(k==='iron') c='#aaa'; if(k==='diamond') c='#0ff'; if(k==='food') c='#e67e22'; if(k==='starfuel') c='#fd79a8';
                    return `<div style="color:${c}">${k.substring(0,4).toUpperCase()}: ${v}</div>`;
                }).join('');
                div.innerHTML = `<strong style="color:var(--accent); display:block; margin-bottom:5px;">${key.toUpperCase().replace('_',' ')}</strong>${costStr}`;
                container.appendChild(div);
            }
        }
        document.getElementById('modal-overlay').style.display = 'flex';
        updateCostPreview();
    }

    function selectStruct(el, key) {
        document.querySelectorAll('.catalog-item').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
        SELECTED_STRUCT = key;
        updateCostPreview();
    }

    function updateCostPreview() {
        if(!CURRENT_COL) return;
        const cDiv = document.getElementById('audit-cost');
        const iDiv = document.getElementById('audit-impact');
        const nameDiv = document.getElementById('selection-name');
        
        if(!SELECTED_STRUCT) {
            nameDiv.innerText = "SELECT BLUEPRINT"; cDiv.innerHTML = "<span style='color:#555'>No selection</span>"; iDiv.innerHTML = "";
            return;
        }
        nameDiv.innerText = SELECTED_STRUCT.toUpperCase().replace('_', ' ');
        const amt = parseInt(document.getElementById('build-amount').value) || 1;
        const source = BUILD_MODE === 'ship' ? STATE.ShipCosts : STATE.Costs;
        const costUnit = source[SELECTED_STRUCT];
        
        let costHtml = "";
        for (const [res, per] of Object.entries(costUnit)) {
            let total = per * amt;
            let curr = CURRENT_COL[res] || 0;
            let remain = curr - total;
            let cls = remain < 0 ? "stat-bad" : "stat-good";
            costHtml += `<div class="audit-row"><span>${res.toUpperCase()}</span><span>${curr} <span style="color:#666">-></span> <span class="${cls}">${remain}</span> <small>(${total})</small></span></div>`;
        }
        cDiv.innerHTML = costHtml;

        if(BUILD_MODE === 'structure') {
            let simCol = JSON.parse(JSON.stringify(CURRENT_COL));
            if(!simCol.buildings) simCol.buildings = {};
            simCol.buildings[SELECTED_STRUCT] = (simCol.buildings[SELECTED_STRUCT]||0) + amt;
            const curRes = calcResRates(CURRENT_COL); const futRes = calcResRates(simCol);
            const curStat = calcStatRates(CURRENT_COL); const futStat = calcStatRates(simCol);
            let impactHtml = "";
            const checkDiff = (label, k, obj1, obj2, isBadHigh=false) => {
                let d = obj2[k] - obj1[k];
                if(Math.abs(d) > 0.01) {
                    let color = (d > 0 && !isBadHigh) || (d < 0 && isBadHigh) ? "var(--success)" : "var(--danger)";
                    impactHtml += `<div class="audit-row"><span>${label} RATE</span> <span style="color:${color}">${d>0?'+':''}${d.toFixed(1)}/t</span></div>`;
                }
            };
            checkDiff("FOOD", 'food', curRes, futRes); checkDiff("WATER", 'water', curRes, futRes); checkDiff("IRON", 'iron', curRes, futRes);
            checkDiff("DIA", 'diamond', curRes, futRes); checkDiff("HEALTH", 'health', curStat, futStat); checkDiff("CRIME", 'crime', curStat, futStat, true);
            checkDiff("HAPPY", 'happy', curStat, futStat);
            iDiv.innerHTML = impactHtml || "<div style='color:#555'>No rate change.</div>";
        } else { iDiv.innerHTML = `<div style='color:var(--accent)'>Fleet Unit.</div>`; }
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    async function confirmBuild() {
        if(!SELECTED_STRUCT) return;
        const amt = parseInt(document.getElementById('build-amount').value);
        const btn = document.getElementById('btn-confirm-build');
        btn.disabled = true; btn.innerText = "PROCESSING...";
        let endpoint = BUILD_MODE === 'ship' ? '/build/ship' : '/build';
        let payload = { colony_id: CURRENT_COL.id, amount: amt };
        if (BUILD_MODE === 'ship') payload.ship_type = SELECTED_STRUCT; else payload.structure = SELECTED_STRUCT;
        try {
            const res = await fetch(`${API}${endpoint}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const txt = await res.text();
            if(res.ok) { log(`<span style="color:var(--success)">CONSTRUCTED: ${amt} ${SELECTED_STRUCT}</span>`); closeModal(); refresh(); } 
            else { log(`<span style="color:var(--danger)">ERROR: ${txt}</span>`); }
        } catch(e) { log("Network Error"); }
        btn.disabled = false; btn.innerText = "AUTHORIZE CONSTRUCTION";
    }

    // --- RENDERERS ---
    function render() {
        if (!STATE) return;
        document.getElementById('srv-uuid').innerText = STATE.ServerUUID || "Unknown";
        document.getElementById('srv-loc').innerText = `[${STATE.ServerLoc || "?"}]`;
        const v = document.getElementById('main-view');
        v.innerHTML = '';

        if(TAB === 'colonies') {
            if(!STATE.MyColonies) { v.innerHTML = "No Colonies"; return; }
            STATE.MyColonies.forEach(c => {
                const b = c.buildings || {};
                const resRates = calcResRates(c);
                const statRates = calcStatRates(c);
                let infraHtml = "";
                for(const [k, count] of Object.entries(b)) {
                    infraHtml += `<div class="build-card"><div style="color:#aaa">${k.toUpperCase().substring(0,8)}</div><div style="font-size:1.2em; font-weight:bold; color:#fff">${count}</div></div>`;
                }
                v.innerHTML += `
                <div class="panel" style="border-left:3px solid var(--accent)">
                    <div style="display:flex; justify-content:space-between">
                        <h3>${c.name}</h3>
                        <div style="text-align:right">
                            <div>POP: <b>${c.population||0}</b> ${fmtRate(statRates.pop)}</div>
                            <div>HAPPY: <b>${Math.floor(c.happiness||0)}%</b> ${fmtRate(statRates.happy)}</div>
                        </div>
                    </div>
                    <div class="res-grid">
                        ${resBox('FOOD', c.food, resRates.food)} ${resBox('WATER', c.water, resRates.water)}
                        ${resBox('IRON', c.iron, resRates.iron)} ${resBox('DIA', c.diamond, resRates.diamond)}
                        ${resBox('PLAT', c.platinum, resRates.platinum)} ${resBox('FUEL', c.starfuel, resRates.starfuel)}
                        ${resBox('HEALTH', c.health, statRates.health)} ${resBox('CRIME', c.crime, statRates.crime, true)}
                    </div>
                    <div style="margin-top:10px; padding:10px; background:#111; border:1px solid #333">
                        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:5px;">${infraHtml}</div>
                        <button onclick="openBuildModal(${c.id}, 'structure')" style="width:100%; margin-top:10px; padding:8px; font-weight:bold; background:rgba(0,210,255,0.1)">+ CATALOG</button>
                    </div>
                </div>`;
            });
        }

        if(TAB === 'fleet') {
            v.innerHTML = `<h3>FLEET COMMAND</h3>`;
            if (STATE.MyColonies) {
                STATE.MyColonies.forEach(c => {
                    v.innerHTML += `
                    <div class="panel">
                        <div style="display:flex; justify-content:space-between; align-items:center">
                            <strong>Shipyard: ${c.name}</strong> 
                            <small>Fe:${c.iron||0} | Fuel:${c.starfuel||0}</small>
                        </div>
                        <button onclick="openBuildModal(${c.id}, 'ship')" style="width:100%; margin-top:5px; padding:10px;">+ OPEN SHIPYARD</button>
                    </div>`;
                });
            }
            if(STATE.MyFleets) {
                STATE.MyFleets.forEach(f => {
                    v.innerHTML += `
                    <div class="panel" style="border:1px solid var(--accent)">
                        <div><strong>Fleet #${f.id}</strong> (Garrison: ${f.origin_colony})</div>
                        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin:5px 0; text-align:center; font-size:0.9em; background:#111; padding:5px;">
                            <div>PROBES<br>${f.probes}</div> <div>FIGHTERS<br>${f.fighters}</div>
                            <div>COLONIZERS<br>${f.colonizers}</div> <div>DESTROYERS<br>${f.destroyers}</div>
                        </div>
                        <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                            <select id="target-${f.id}" style="margin-bottom:5px;">
                                <option value="">-- SELECT TARGET --</option>
                                ${Object.values(STATE.Intel || {}).map(i => `<option value="${i.server_url}">${i.server_uuid}</option>`).join('')}
                            </select>
                            <button class="btn-dang" onclick="launchFleet(${f.id})" style="width:100%">LAUNCH MISSION</button>
                        </div>
                    </div>`;
                });
            }
        }

        if(TAB === 'intel') {
            v.innerHTML = `
            <div class="panel">
                <h3>MANUAL SENSOR INPUT</h3>
                <div style="display:flex; gap:10px;">
                    <input id="new-net" placeholder="http://target:port"> 
                    <button onclick="addNet()">ADD</button>
                </div>
            </div>`;
            
            if(STATE.Intel) {
                Object.values(STATE.Intel).forEach(r => {
                     let locStr = r.location ? `[${r.location}]` : "[Unknown]";
                     let peersStr = r.peers ? r.peers.join(", ") : "None";
                     let stampInfo = r.last_stamp ? `<span style="color:var(--success)">VERIFIED</span>` : `<span style="color:var(--danger)">UNVERIFIED</span>`;
                     let content = `
                     <div style="color:var(--accent)">
                        <strong>DATA DECRYPTED</strong><br>
                        UUID: ${r.server_uuid} ${stampInfo}<br>
                        COORDS: ${locStr} | PEERS: ${peersStr}
                     </div>
                     <div style="margin-top:5px; padding:5px; background:#111;">
                        ${(r.colonies||[]).map(c => `<div>â€¢ ${c.name} (Def: ${c.defense_rating})</div>`).join('')}
                     </div>`;
                     v.innerHTML += `<div class="panel"><strong>${r.server_url}</strong><br>${content}</div>`;
                });
            } else {
                v.innerHTML += `<div class="panel" style="color:#666">No Sector Intel</div>`;
            }
        }
    }

    async function launchFleet(fid) {
        const url = document.getElementById(`target-${fid}`).value;
        if(!url) return alert("Select target");
        log("Launching Fleet...");
        try {
            const res = await fetch(`${API}/fleet/launch`, {
                method:'POST', headers: {'Content-Type': 'application/json'},
                body:JSON.stringify({FleetID:fid, TargetURL:url})
            });
            const d = await res.json();
            if(d.combat_log) log(d.combat_log);
            if(d.scan_result) log(d.scan_result);
            refresh();
        } catch(e) { log("Launch Failed"); }
    }
    function setTab(t) { 
        TAB=t; 
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${t}`).classList.add('active');
        render(); 
    }
    async function addNet() { 
        const u = document.getElementById('new-net').value;
        if(u) {
            log("Handshaking...");
            try {
                const res = await fetch(`${API}/federation/add_peer`, {method:'POST', body:JSON.stringify({TargetURL:u})});
                const d = await res.json();
                log(`Handshake: ${d.status}`);
                refresh();
            } catch(e) { log("Handshake Error"); }
        }
    }
</script>
</body>
</html>
